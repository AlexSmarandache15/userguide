<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="examples-schematron-use_case_3">
  <title>Schematron Use Case 3: Check for Broken Links</title>
  <body>
    <p><b>Description:</b> The following sample rule detects broken links in DITA
        <xmlelement>xref</xmlelement> or <xmlelement>link</xmlelement> elements. The first example
      only checks links that do not contain an anchor (<b>#</b>).</p>
    <p><b>Sample Code:</b><codeblock outputclass="language-xml">&lt;rule
  context="*[contains(@class, ' topic/xref ') or contains(@class, ' topic/link ')]
  [@href][not(contains(@href, '#'))][not(@scope = 'external')]
  [not(@type) or @type='dita']"&gt;
  &lt;assert test="doc-available(resolve-uri(@href, base-uri(.)))"&gt;
    The document linked by &lt;value-of select="local-name()"/&gt; 
    "&lt;value-of select="@href"/&gt;" does not exist!&lt;/assert&gt;
&lt;/rule&gt;</codeblock></p>
    <p>For links that contain an anchor, the Schematron rule must look something like
      this:<codeblock outputclass="language-xml">&lt;rule
  context="*[contains(@class, ' topic/xref ') or contains(@class, ' topic/link ')]
  [@href][contains(@href, '#')][not(@scope = 'external')]
  [not(@type) or @type='dita']"&gt;
  &lt;let name="file" value="substring-before(@href, '#')"/&gt;
  &lt;let name="idPart" value="substring-after(@href, '#')"/&gt;
  &lt;let name="topicId"
    value="if (contains($idPart, '/')) then substring-before($idPart, '/') else $idPart"/&gt;
  &lt;let name="id" value="substring-after($idPart, '/')"/&gt;
  
  &lt;assert test="document($file, .)//*[@id=$topicId]"&gt;
    Invalid topic id "&lt;value-of select="$topicId"/&gt;" &lt;/assert&gt;
  &lt;assert test="$id ='' or document($file, .)//*[@id=$id]"&gt;
    No such id "&lt;value-of select="$id"/&gt;" is defined! &lt;/assert&gt;
  &lt;assert test="$id='' or document($file, .)//*[@id=$id]
    [ancestor::*[contains(@class, ' topic/topic ')][1][@id=$topicId]]"&gt; 
    The id "&lt;value-of select="$id"/&gt;" is not in the scope of the referenced topic id 
    "&lt;value-of select="$topicId"/&gt;". &lt;/assert&gt;
&lt;/rule&gt;</codeblock></p>
    <p><b>Result:</b> The engine displays an error message when a broken link or cross reference is
      detected.</p>
  </body>
</topic>